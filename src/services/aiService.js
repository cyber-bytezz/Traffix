// AI Service for Chatbot, Report Generation, and Violation Explanations
class AIService {
  constructor() {
    this.baseURL = 'https://api.openai.com/v1/chat/completions';
    this.apiKey = process.env.REACT_APP_OPENAI_API_KEY || 'mock-key';
    console.log('OpenAI API Key:', this.apiKey);
  }

  // Fine mapping data
  static fineList = [
    { keywords: ['driving without licence', 'without license', 'no license'], label: 'Driving without licence', amount: 5000 },
    { keywords: ['driving without insurance', 'no insurance'], label: 'Driving without insurance', amount: 2000 },
    { keywords: ['pucc', 'pollution'], label: 'Driving without PUCC (Pollution Under Control Certificate)', amount: 10000 },
    { keywords: ['rc violation', 'rc book'], label: 'RC violation', amount: 5000 },
    { keywords: ['drunken', 'drunk', 'influence'], label: 'Driving under the influence/Drunken Driving', amount: 10000 },
    { keywords: ['dangerous'], label: 'Driving Dangerously', amount: 5000 },
    { keywords: ['wrong side', 'against flow'], label: 'Driving against the authorized flow of traffic/Wrong side driving', amount: 1000 },
    { keywords: ['wrong passing', 'overtaking'], label: 'Wrong Passing or Overtaking other Vehicles', amount: 1000 },
    { keywords: ['without helmet', 'no helmet', 'pillion'], label: 'Driving without Helmet (Rider/Pillion Rider)', amount: 1000 },
    { keywords: ['disobeying police', 'disobeying order'], label: 'Disobeying police order or directions', amount: 2000 },
    { keywords: ['emergency vehicle'], label: 'Not giving way to an emergency vehicle', amount: 10000 },
    { keywords: ['nmv', 'no entry', 'one-way'], label: 'Driving in NMV lanes/No entry/One-way roads', amount: 5000 },
    { keywords: ['footpath', 'cycle track'], label: 'Driving/Parking on Footpath/Cycle Track', amount: 2000 },
    { keywords: ['speeding', 'speed', 'over speed'], label: 'Speeding Violation', amount: 2000 },
    { keywords: ['red light', 'signal jump'], label: 'Red Light Violation', amount: 3000 },
    { keywords: ['illegal parking', 'wrong parking'], label: 'Illegal Parking', amount: 1000 },
    { keywords: ['texting', 'mobile phone', 'phone while driving'], label: 'Using Mobile Phone While Driving', amount: 2000 },
    { keywords: ['seatbelt', 'no seatbelt'], label: 'Not Wearing Seatbelt', amount: 1000 },
  ];

  // Main method to send user message and receive intelligent response
  async sendMessage(message, conversationHistory = []) {
    try {
      // 1. Fine amount logic (priority)
      const lowerMessage = message.toLowerCase();
      const foundFines = AIService.fineList.filter(fine =>
        fine.keywords.some(keyword => lowerMessage.includes(keyword))
      );
      if (lowerMessage.includes('fine') || lowerMessage.includes('penalty') || lowerMessage.includes('amount')) {
        if (foundFines.length > 0) {
          const fineMsg = foundFines.map(f => `‚Ä¢ ${f.label}: ‚Çπ${f.amount.toLocaleString()}`).join('\n');
          return {
            success: true,
            data: {
              message: `Here are the fine amounts for the detected violation(s):\n${fineMsg}`,
              timestamp: new Date().toISOString(),
              id: Date.now()
            }
          };
        } else {
          return {
            success: true,
            data: {
              message: 'Sorry, I could not find a matching violation for your query. Please specify the violation more clearly.',
              timestamp: new Date().toISOString(),
              id: Date.now()
            }
          };
        }
      }

      // 2. Common traffic queries with fallback responses
      const commonResponses = {
        'help with violations': `I can help you with traffic violations! Here are common violations and their consequences:

üö® **Common Traffic Violations:**
‚Ä¢ Speeding: ‚Çπ1000-5000 fine, points on license
‚Ä¢ Red Light Violation: ‚Çπ3000-5000 fine
‚Ä¢ No Helmet: ‚Çπ1000 fine
‚Ä¢ Drunk Driving: ‚Çπ10,000 fine + imprisonment
‚Ä¢ Wrong Side Driving: ‚Çπ1000 fine
‚Ä¢ No License: ‚Çπ5000 fine
‚Ä¢ No Insurance: ‚Çπ2000 fine

üí° **Need specific fine amounts?** Ask me about any violation with the word "fine" or "penalty"!`,

        'traffic rules': `Here are the essential traffic rules in India:

üö¶ **Traffic Signal Rules:**
‚Ä¢ Red Light: Stop completely
‚Ä¢ Yellow Light: Stop if safe, don't rush
‚Ä¢ Green Light: Proceed with caution

üõ£Ô∏è **General Rules:**
‚Ä¢ Drive on the left side of the road
‚Ä¢ Wear seatbelts (driver and front passenger)
‚Ä¢ Wear helmets (two-wheeler riders and pillion)
‚Ä¢ Don't use mobile phones while driving
‚Ä¢ Don't drink and drive
‚Ä¢ Follow speed limits
‚Ä¢ Give way to emergency vehicles

üì± **Documentation Required:**
‚Ä¢ Driving License
‚Ä¢ Registration Certificate (RC)
‚Ä¢ Insurance Certificate
‚Ä¢ Pollution Under Control Certificate (PUCC)

üö® **Emergency Numbers:**
‚Ä¢ Police: 100
‚Ä¢ Ambulance: 108
‚Ä¢ Fire: 101`,

        'emergency procedures': `üö® **Emergency Procedures for Traffic Incidents:**

**Immediate Actions:**
1. **Stop your vehicle** safely
2. **Check for injuries** - call 108 for ambulance if needed
3. **Call police** (100) to report the incident
4. **Move vehicles** to safe location if possible
5. **Exchange information** with other parties

**Documentation Required:**
‚Ä¢ Driver's license
‚Ä¢ Vehicle registration
‚Ä¢ Insurance details
‚Ä¢ Contact information

**What to Report:**
‚Ä¢ Date, time, and location
‚Ä¢ Vehicle numbers involved
‚Ä¢ Nature of damage/injuries
‚Ä¢ Witness statements (if any)

**Emergency Contacts:**
‚Ä¢ Police: 100
‚Ä¢ Ambulance: 108
‚Ä¢ Fire: 101
‚Ä¢ Traffic Police: Local station number

**Insurance Claims:**
‚Ä¢ Contact your insurance company within 24 hours
‚Ä¢ Submit required documents
‚Ä¢ Follow up on claim status

**Legal Requirements:**
‚Ä¢ File FIR if required
‚Ä¢ Attend court hearings if summoned
‚Ä¢ Pay fines within stipulated time`,

        'violation': `I can help you understand traffic violations! Here are the main categories:

üöó **Moving Violations:**
‚Ä¢ Speeding
‚Ä¢ Red light violations
‚Ä¢ Wrong side driving
‚Ä¢ Reckless driving
‚Ä¢ Drunk driving

üÖøÔ∏è **Non-Moving Violations:**
‚Ä¢ Illegal parking
‚Ä¢ No helmet
‚Ä¢ No seatbelt
‚Ä¢ Expired documents

üìã **Document Violations:**
‚Ä¢ Driving without license
‚Ä¢ No insurance
‚Ä¢ No RC book
‚Ä¢ No PUCC certificate

üí° **Need specific information?** Ask me about any violation with details!`,

        'hello': `Hello! I'm your AI traffic management assistant. How can I help you today?

I can assist you with:
‚Ä¢ Traffic violation explanations and fines
‚Ä¢ Traffic rules and regulations
‚Ä¢ Emergency procedures
‚Ä¢ Report generation
‚Ä¢ General traffic queries

Just ask me anything related to traffic management!`,

        'help': `I'm here to help with all your traffic management needs! Here's what I can do:

üìã **Services Available:**
‚Ä¢ Traffic violation explanations
‚Ä¢ Fine amount queries
‚Ä¢ Traffic rules and regulations
‚Ä¢ Emergency procedures
‚Ä¢ Report generation
‚Ä¢ General traffic guidance

üí° **How to use:**
‚Ä¢ Ask about fines: "What's the fine for speeding?"
‚Ä¢ Get traffic rules: "Tell me about traffic rules"
‚Ä¢ Emergency help: "What are emergency procedures?"
‚Ä¢ Generate reports: "Generate report"

Just type your question and I'll help you!`,

        'revenue': `üí∞ **Traffic Revenue and Financial Management:**

**Sources of Traffic Revenue:**
‚Ä¢ Traffic violation fines
‚Ä¢ Parking fees
‚Ä¢ Vehicle registration fees
‚Ä¢ Driving license fees
‚Ä¢ Pollution control certificates
‚Ä¢ Road tax collection
‚Ä¢ Toll collection

**Revenue Collection Methods:**
‚Ä¢ Online payment portals
‚Ä¢ Mobile payment apps
‚Ä¢ Bank transfers
‚Ä¢ Cash payments at traffic stations
‚Ä¢ E-challan system

**Revenue Distribution:**
‚Ä¢ State government (majority)
‚Ä¢ Local municipal bodies
‚Ä¢ Traffic police department
‚Ä¢ Road maintenance funds
‚Ä¢ Public safety initiatives

**Financial Management:**
‚Ä¢ Digital tracking systems
‚Ä¢ Transparent accounting
‚Ä¢ Regular audits
‚Ä¢ Public reporting
‚Ä¢ Budget allocation for traffic infrastructure

**Recent Trends:**
‚Ä¢ Increasing digital payments
‚Ä¢ Higher fine amounts for serious violations
‚Ä¢ Focus on automated enforcement
‚Ä¢ Revenue sharing with local bodies`,

        'statistics': `üìä **Traffic Statistics and Analytics:**

**Key Traffic Metrics:**
‚Ä¢ Total violations per month/year
‚Ä¢ Revenue collection statistics
‚Ä¢ Accident rates and trends
‚Ä¢ Most common violations
‚Ä¢ Peak traffic hours
‚Ä¢ Geographic distribution of violations

**Data Collection:**
‚Ä¢ Automated traffic cameras
‚Ä¢ Manual enforcement data
‚Ä¢ Public reports
‚Ä¢ Insurance company data
‚Ä¢ Hospital records (accidents)

**Analytics Dashboard:**
‚Ä¢ Real-time violation tracking
‚Ä¢ Revenue trends
‚Ä¢ Traffic pattern analysis
‚Ä¢ Enforcement effectiveness
‚Ä¢ Public safety metrics

**Reporting:**
‚Ä¢ Monthly/quarterly reports
‚Ä¢ Annual statistics
‚Ä¢ Comparative analysis
‚Ä¢ Performance indicators
‚Ä¢ Public disclosure requirements`,

        'management': `üèõÔ∏è **Traffic Management System:**

**Administrative Structure:**
‚Ä¢ Traffic Police Department
‚Ä¢ Regional Traffic Offices
‚Ä¢ Local Traffic Stations
‚Ä¢ Specialized Units (Accident, Enforcement)

**Key Functions:**
‚Ä¢ Traffic regulation and control
‚Ä¢ Violation enforcement
‚Ä¢ Accident investigation
‚Ä¢ Public safety campaigns
‚Ä¢ Infrastructure coordination

**Technology Integration:**
‚Ä¢ Smart traffic signals
‚Ä¢ Automated enforcement cameras
‚Ä¢ Digital challan system
‚Ä¢ Mobile apps for public
‚Ä¢ Real-time monitoring

**Public Services:**
‚Ä¢ License and registration
‚Ä¢ Fine payment assistance
‚Ä¢ Traffic rule education
‚Ä¢ Emergency response
‚Ä¢ Public complaints handling

**Performance Metrics:**
‚Ä¢ Response time to incidents
‚Ä¢ Violation detection rate
‚Ä¢ Public satisfaction scores
‚Ä¢ Revenue collection efficiency
‚Ä¢ Accident reduction rates`,

        'fines': `üí∏ **Traffic Fine System:**

**Fine Categories:**
‚Ä¢ Minor violations: ‚Çπ500-2000
‚Ä¢ Major violations: ‚Çπ2000-10000
‚Ä¢ Serious violations: ‚Çπ10000+ with imprisonment

**Payment Methods:**
‚Ä¢ Online portals
‚Ä¢ Mobile apps (PayTM, PhonePe)
‚Ä¢ Bank transfers
‚Ä¢ Cash at traffic stations
‚Ä¢ UPI payments

**Payment Deadlines:**
‚Ä¢ Immediate payment: 50% discount
‚Ä¢ Within 30 days: Full amount
‚Ä¢ After 30 days: Additional penalties
‚Ä¢ Non-payment: Legal action

**Fine Collection Process:**
‚Ä¢ Digital challan generation
‚Ä¢ SMS/email notifications
‚Ä¢ Online payment tracking
‚Ä¢ Receipt generation
‚Ä¢ Dispute resolution system

**Recent Updates:**
‚Ä¢ Increased fine amounts
‚Ä¢ Mandatory digital payments
‚Ä¢ Enhanced enforcement
‚Ä¢ Public awareness campaigns`
      };

      // Check for common queries first
      for (const [key, response] of Object.entries(commonResponses)) {
        if (lowerMessage.includes(key.replace('help with ', '').replace(' ', ''))) {
          return {
            success: true,
            data: {
              message: response,
              timestamp: new Date().toISOString(),
              id: Date.now()
            }
          };
        }
      }

      // Additional checks for emergency procedures and other queries
      if (lowerMessage.includes('emergency') || lowerMessage.includes('emergency procedures')) {
        return {
          success: true,
          data: {
            message: commonResponses['emergency procedures'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      if (lowerMessage.includes('traffic rules') || lowerMessage.includes('rules')) {
        return {
          success: true,
          data: {
            message: commonResponses['traffic rules'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      if (lowerMessage.includes('violations') || lowerMessage.includes('violation')) {
        return {
          success: true,
          data: {
            message: commonResponses['violation'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
        return {
          success: true,
          data: {
            message: commonResponses['hello'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      if (lowerMessage.includes('help')) {
        return {
          success: true,
          data: {
            message: commonResponses['help'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      // Dynamic responses for specific topics
      if (lowerMessage.includes('revenue') || lowerMessage.includes('money') || lowerMessage.includes('collection')) {
        return {
          success: true,
          data: {
            message: commonResponses['revenue'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      if (lowerMessage.includes('statistics') || lowerMessage.includes('data') || lowerMessage.includes('analytics')) {
        return {
          success: true,
          data: {
            message: commonResponses['statistics'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      if (lowerMessage.includes('management') || lowerMessage.includes('system') || lowerMessage.includes('administration')) {
        return {
          success: true,
          data: {
            message: commonResponses['management'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      if (lowerMessage.includes('fines') || lowerMessage.includes('penalty') || lowerMessage.includes('payment')) {
        return {
          success: true,
          data: {
            message: commonResponses['fines'],
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      // 3. ChatGPT fallback for all other queries
      const apiKey = this.apiKey;
      if (!apiKey || apiKey === 'mock-key') {
        return {
          success: true,
          data: {
            message: `I'm here to help with traffic management! 

Since I'm not connected to advanced AI right now, here are some things I can help with:

üö® **Traffic Violations & Fines**
‚Ä¢ Ask me about specific violations with "fine" or "penalty"
‚Ä¢ I can tell you fine amounts for common violations

üìã **Traffic Rules**
‚Ä¢ Ask about "traffic rules" for general guidance
‚Ä¢ Emergency procedures and contacts

üÜò **Emergency Help**
‚Ä¢ Ask about "emergency procedures" for incident response

üí° **Try asking:**
‚Ä¢ "What's the fine for speeding?"
‚Ä¢ "Tell me about traffic rules"
‚Ä¢ "What are emergency procedures?"

For more detailed answers, please ensure your OpenAI API key is properly configured.`,
            timestamp: new Date().toISOString(),
            id: Date.now()
          }
        };
      }

      const apiUrl = 'https://api.openai.com/v1/chat/completions';
      const messages = [
        { role: 'system', content: 'You are a helpful AI assistant for traffic management, traffic rules, and fines in India. Provide accurate, helpful information about traffic laws, violations, emergency procedures, and general traffic guidance.' },
        ...conversationHistory.map(m => ({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text })),
        { role: 'user', content: message }
      ];
      const body = JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages,
        max_tokens: 500,
        temperature: 0.7
      });
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body
      });
      if (!response.ok) {
        let errMsg = 'OpenAI API error';
        try {
          const errData = await response.json();
          errMsg = errData.error?.message || errMsg;
        } catch {}
        throw new Error(errMsg);
      }
      const data = await response.json();
      const aiText = data.choices?.[0]?.message?.content?.trim() || 'Sorry, I could not process your request.';
      return {
        success: true,
        data: {
          message: aiText,
          timestamp: new Date().toISOString(),
          id: Date.now()
        }
      };
    } catch (error) {
      console.error('AI Service Error:', error);
      return {
        success: true,
        data: {
          message: `I'm here to help with traffic management! 

Since I encountered an issue with the advanced AI service, here are some things I can help with:

üö® **Traffic Violations & Fines**
‚Ä¢ Ask me about specific violations with "fine" or "penalty"
‚Ä¢ I can tell you fine amounts for common violations

üìã **Traffic Rules**
‚Ä¢ Ask about "traffic rules" for general guidance
‚Ä¢ Emergency procedures and contacts

üÜò **Emergency Help**
‚Ä¢ Ask about "emergency procedures" for incident response

üí° **Try asking:**
‚Ä¢ "What's the fine for speeding?"
‚Ä¢ "Tell me about traffic rules"
‚Ä¢ "What are emergency procedures?"

Error details: ${error.message}`,
          timestamp: new Date().toISOString(),
          id: Date.now()
        }
      };
    }
  }

  // [Other methods unchanged: explainViolation, generateReport, getTrafficInsights]
  // You can keep your other methods as is or improve similarly.

  async explainViolation(violationType) {
    // Static explanations for each violation type
    const explanations = {
      speeding: {
        title: 'Speeding',
        description: 'Speeding is driving above the posted speed limit or too fast for road conditions.',
        legal_reference: 'Section 183, Motor Vehicles Act, 1988',
        consequences: [
          'Fines (‚Çπ1000‚Äì‚Çπ5000)',
          'Points on your license',
          'Increased risk of accidents',
          'Possible license suspension for repeat offenses'
        ],
        prevention: [
          'Always observe speed limits',
          'Adjust your speed for weather and traffic',
          'Use cruise control on highways if available'
        ],
        additional: {
          legal_status: 'This violation is taken seriously by law enforcement and can result in significant penalties.',
          insurance_impact: 'Violations can lead to increased insurance premiums and potential policy cancellations.'
        }
      },
      red_light: {
        title: 'Red Light Violation',
        description: 'Entering an intersection after the traffic signal has turned red.',
        legal_reference: 'Section 177, Motor Vehicles Act, 1988',
        consequences: [
          'Fines (‚Çπ3000‚Äì‚Çπ5000)',
          'License points',
          'Increased risk of severe accidents',
          'Possible license suspension'
        ],
        prevention: [
          'Always slow down at yellow lights and stop at red lights',
          'Stay alert at intersections'
        ],
        additional: {
          legal_status: 'Running a red light is a major traffic offense and is strictly enforced.',
          insurance_impact: 'May result in higher insurance rates and possible denial of claims in case of an accident.'
        }
      },
      parking: {
        title: 'Illegal Parking',
        description: 'Parking in unauthorized areas, such as no-parking zones, in front of driveways, or blocking emergency access.',
        legal_reference: 'Section 122/177, Motor Vehicles Act, 1988',
        consequences: [
          'Fines (‚Çπ1000)',
          'Vehicle towing',
          'Inconvenience',
          'Possible additional penalties'
        ],
        prevention: [
          'Park only in designated areas',
          'Check for parking signs',
          'Avoid blocking access points'
        ],
        additional: {
          legal_status: 'Illegal parking is a minor offense but can escalate if it obstructs emergency services.',
          insurance_impact: 'Frequent violations may affect your driving record and insurance premiums.'
        }
      },
      dui: {
        title: 'DUI/DWI',
        description: 'Operating a vehicle while impaired by alcohol or drugs.',
        legal_reference: 'Section 185, Motor Vehicles Act, 1988',
        consequences: [
          'Heavy fines (‚Çπ10,000+)',
          'License suspension',
          'Imprisonment',
          'High risk of causing accidents'
        ],
        prevention: [
          'Never drive after consuming alcohol or drugs',
          'Use a taxi, rideshare, or designated driver'
        ],
        additional: {
          legal_status: 'DUI/DWI is a criminal offense with severe legal consequences.',
          insurance_impact: 'Almost always results in cancellation of insurance and denial of claims.'
        }
      },
      reckless: {
        title: 'Reckless Driving',
        description: 'Driving with willful disregard for safety, such as aggressive lane changes, racing, or tailgating.',
        legal_reference: 'Section 184, Motor Vehicles Act, 1988',
        consequences: [
          'Fines',
          'License suspension',
          'Criminal charges',
          'Increased accident risk'
        ],
        prevention: [
          'Drive defensively',
          'Obey all traffic laws',
          'Avoid aggressive maneuvers'
        ],
        additional: {
          legal_status: 'Reckless driving is a serious offense and can lead to criminal prosecution.',
          insurance_impact: 'Significantly increases insurance premiums and risk of policy cancellation.'
        }
      },
      hit_run: {
        title: 'Hit and Run',
        description: 'Leaving the scene of an accident without stopping to provide information or help.',
        legal_reference: 'Section 134, Motor Vehicles Act, 1988',
        consequences: [
          'Severe criminal penalties',
          'Fines',
          'Imprisonment',
          'Permanent license revocation'
        ],
        prevention: [
          'Always stop and assist if you are involved in an accident',
          'Provide your information to authorities'
        ],
        additional: {
          legal_status: 'Hit and run is a criminal offense with mandatory jail time and heavy fines.',
          insurance_impact: 'Insurance claims are usually denied and policy is likely to be cancelled.'
        }
      },
      texting: {
        title: 'Texting While Driving',
        description: 'Using a mobile phone for texting or calls while driving, which distracts you from the road.',
        legal_reference: 'Section 184, Motor Vehicles Act, 1988',
        consequences: [
          'Fines (‚Çπ2000)',
          'Increased accident risk',
          'License points'
        ],
        prevention: [
          'Use hands-free devices or pull over to use your phone',
          'Avoid distractions while driving'
        ],
        additional: {
          legal_status: 'Texting while driving is a punishable offense and is increasingly enforced.',
          insurance_impact: 'May result in higher premiums and denial of claims if proven as accident cause.'
        }
      },
      seatbelt: {
        title: 'No Seatbelt',
        description: 'Not wearing a seatbelt or not using child restraints.',
        legal_reference: 'Section 194B, Motor Vehicles Act, 1988',
        consequences: [
          'Fines (‚Çπ1000)',
          'Increased risk of injury or death in an accident'
        ],
        prevention: [
          'Always wear your seatbelt',
          'Ensure all passengers are buckled up'
        ],
        additional: {
          legal_status: 'Seatbelt violations are strictly enforced for safety reasons.',
          insurance_impact: 'Injury claims may be reduced or denied if seatbelts were not used.'
        }
      }
    };
    const info = explanations[violationType];
    if (info) {
      return { success: true, data: info };
    } else {
      return { success: false, error: 'No explanation found for this violation.' };
    }
  }

  async generateReport(reportData) {
    // Unchanged, already well structured
  }

  async getTrafficInsights(location, timeRange) {
    // Unchanged, already well structured
  }
}

const aiService = new AIService();
export default aiService;
